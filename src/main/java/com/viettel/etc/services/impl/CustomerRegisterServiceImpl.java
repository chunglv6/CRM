package com.viettel.etc.services.impl;import com.viettel.etc.dto.ServiceFeeDTO;import com.viettel.etc.dto.ServiceRegisterDTO;import com.viettel.etc.dto.boo.ReqActivationCheckDTO;import com.viettel.etc.dto.boo.ResActivationCheckDTO;import com.viettel.etc.dto.viettelpost.BillRequestDTO;import com.viettel.etc.dto.viettelpost.BillResponseDTO;import com.viettel.etc.dto.viettelpost.ConfirmOrderDTO;import com.viettel.etc.dto.viettelpost.ConfirmOrderResDTO;import com.viettel.etc.repositories.tables.VehicleRepositoryJPA;import com.viettel.etc.repositories.tables.WsAuditRepositoryJPA;import com.viettel.etc.repositories.tables.entities.*;import com.viettel.etc.services.*;import com.viettel.etc.services.tables.ContractServiceJPA;import com.viettel.etc.services.tables.CustRegisServiceJPA;import com.viettel.etc.services.tables.OtpServiceJPA;import com.viettel.etc.services.tables.VehicleServiceJPA;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.ErrorApp;import com.viettel.etc.utils.FnCommon;import com.viettel.etc.utils.exceptions.EtcException;import lombok.extern.log4j.Log4j;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.http.HttpStatus;import org.springframework.stereotype.Service;import java.util.*;/** * Autogen class: Lop dich vu * * @author ToolGen * @date Fri Jul 10 09:53:01 ICT 2020 */@Service@Log4jpublic class CustomerRegisterServiceImpl implements ServiceRegistryService {    private static final Logger LOGGER = LoggerFactory.getLogger(CustomerRegisterServiceImpl.class);    @Autowired    private CustRegisServiceJPA custRegisServiceJPA;    @Autowired    private OtpServiceJPA otpServiceJPA;    @Autowired    private ContractServiceJPA contractServiceJPA;    @Autowired    Boo1ServiceImpl boo1Service;    @Autowired    WsAuditRepositoryJPA wsAuditRepositoryJPA;    @Autowired    VehicleRepositoryJPA vehicleRepositoryJPA;    @Autowired    JedisCacheService jedisCacheService;    @Autowired    VehicleServiceJPA vehicleServiceJPA;    @Autowired    VehicleService vehicleService;    @Autowired    ServiceFeeService serviceFeeService;    @Autowired    ViettelPostService viettelPostService;    @Autowired    SearchXCGService searchXCGService;    /**     * Dang ky dich vu     * API App CPT     *     * @param itemParamsEntity params client     * @param remoteAddr     * @return     */    @Override    public BillResponseDTO register(ServiceRegisterDTO itemParamsEntity, String remoteAddr) {        OtpIdentify otpId = new OtpIdentify();        if (itemParamsEntity.getCustomerType() != null && Constants.CUS_ENTERPRISE.equals(itemParamsEntity.getCustomerType())) {            otpId.setPhone(itemParamsEntity.getRepPhoneNumber());        } else {            otpId.setPhone(itemParamsEntity.getPhoneNumber());        }        otpId.setConfirmType(OtpIdentify.REGISTER);        if (!otpServiceJPA.existsById(otpId)) {            throw new EtcException("validate.otp.not.exist");        }        OtpEntity otpEntity = otpServiceJPA.getById(otpId);        if (!otpEntity.getOtp().equals(itemParamsEntity.getOtp())) {            throw new EtcException("validate.otp.wrong");        }        long diff = new Date().getTime() - otpEntity.getSignDate().getTime();        if (diff > otpEntity.getDuration() * 1000 * 60) {   // diff in minute            throw new EtcException("validate.opt.expired");        }        ServiceFeeDTO serviceFee = (ServiceFeeDTO) serviceFeeService.getDetailServiceFeeByReason(Constants.ACT_REASON.ACTIVE_RFID);        Long fee = serviceFee.getFee();        long price = fee;        if (!FnCommon.isNullOrEmpty(itemParamsEntity.getPlateNumber())) {            if (!FnCommon.validatePlateContainsTVX(itemParamsEntity.getPlateNumber())) {                throw new EtcException("common.validate.plate.number");            }            if (custRegisServiceJPA.existsByPhoneNumberAndPlateNumber(otpId.getPhone(), itemParamsEntity.getPlateNumber())) {                Map<String, String> parameter = new HashMap<>();                parameter.put(":phoneNumber", otpId.getPhone());                parameter.put(":plateNumber", itemParamsEntity.getPlateNumber());                throw new EtcException("crm.validate.plate.phone.duplicate", parameter);            }            price = 0L;            String plateTypeCode = FnCommon.getPlateTypeBOO1(itemParamsEntity.getPlateNumber());            String plate = FnCommon.formatPlateBOO1(itemParamsEntity.getPlateNumber());            String status = vehicleService.checkVehicle(plate, plateTypeCode);            if (status == null) {                throw new EtcException("crm.vehicle.boo1.connect.fail");            }            if (Constants.BOO_STATUS.ACTIVE.equals(status)) {                throw new EtcException("crm.vehicle.already.active");            }            if (Calendar.getInstance().get(Calendar.YEAR) > 2021 || Constants.BOO_STATUS.DESTROY.equals(status)) {                price = fee;            }        }        BillRequestDTO requestDTO = new BillRequestDTO(itemParamsEntity, price);        CustRegisEntity custRegisEntity = new CustRegisEntity();        custRegisEntity.setCustName(itemParamsEntity.getFullName());        custRegisEntity.setCustTypeId(itemParamsEntity.getCustomerType());        custRegisEntity.setDocumentNumber(itemParamsEntity.getIdentifier());        custRegisEntity.setPhoneNumber(otpEntity.getPhone());        custRegisEntity.setOwner(itemParamsEntity.getOwner());        custRegisEntity.setPlateNumber(itemParamsEntity.getPlateNumber());        custRegisEntity.setTimeFrame(itemParamsEntity.getTimeFrame());        custRegisEntity.setStreet(itemParamsEntity.getStreet());        custRegisEntity.setRegStatus(CustRegisEntity.RegStatus.NEW.value);        custRegisEntity.setAreaCode(itemParamsEntity.getAreaCode());        custRegisEntity.setBirthDate(itemParamsEntity.getBirthDate());        custRegisEntity.setDateOfIssue(itemParamsEntity.getDateOfIssue());        custRegisEntity.setPlaceOfIssue(itemParamsEntity.getPlaceOfIssue());        custRegisEntity.setEmail(itemParamsEntity.getEmail());        custRegisEntity.setNumVehicle(itemParamsEntity.getNumVehicle());        custRegisEntity.setRepIdentityNumber(itemParamsEntity.getRepIdentityNumber());        custRegisEntity.setRepIdentityTypeId(itemParamsEntity.getRepIdentityTypeId());        custRegisEntity.setRepDateOfIssue(itemParamsEntity.getRepDateOfIssue());        custRegisEntity.setRepPlaceOfIssue(itemParamsEntity.getRepPlaceOfIssue());        custRegisEntity.setRepName(itemParamsEntity.getRepName());        custRegisEntity.setRepBirthDate(itemParamsEntity.getRepBirthDate());        custRegisEntity.setRepAreaCode(itemParamsEntity.getRepAreaCode());        custRegisEntity.setRepStreet(itemParamsEntity.getRepStreet());        custRegisEntity.setRepEmail(itemParamsEntity.getRepEmail());        custRegisEntity.setRepPhoneNumber(itemParamsEntity.getRepPhoneNumber());        custRegisEntity.setProvinceName(itemParamsEntity.getProvinceName());        custRegisEntity.setDistrictName(itemParamsEntity.getDistrictName());        custRegisEntity.setCommuneName(itemParamsEntity.getWardName());        custRegisServiceJPA.save(custRegisEntity);        BillResponseDTO responseDTO;        if (itemParamsEntity.getStickType() == null || Constants.STICKY_TYPE.SHOP.equals(itemParamsEntity.getStickType())) {            otpServiceJPA.delete(otpEntity);            custRegisServiceJPA.save(custRegisEntity);            responseDTO = new BillResponseDTO();            responseDTO.setStatus(HttpStatus.OK.value());            responseDTO.setError(false);            return responseDTO;        }        otpServiceJPA.delete(otpEntity);        responseDTO = viettelPostService.createBill(requestDTO, remoteAddr);        if (!responseDTO.getError()) {            custRegisEntity.setOrderNumber(responseDTO.getData().getORDER_NUMBER());            custRegisServiceJPA.save(custRegisEntity);        }        return responseDTO;    }    @Override    public Object checkVehicle(String plate) throws Exception {        plate = plate.toUpperCase();        if (!FnCommon.validatePlateContainsTVX(plate)) {            throw new EtcException("common.validate.plate.number");        }        String plateNumber = FnCommon.formatPlateBOO1(plate);        String plateTypeCode = FnCommon.getPlateTypeBOO1(plate);        String plateType = FnCommon.mappingPlateTypeBOO2ToBOO1(plateTypeCode);        plate = FnCommon.getPlateNumberBoo1(plateNumber, plateType);        VehicleEntity vehicleEntity = vehicleServiceJPA.getActiveByPlateNumberAndPlateTypeCode(plateNumber, plateTypeCode);        if (vehicleEntity != null && !Constants.BOO_INFO.CONTRACT_ID.equals(vehicleEntity.getContractId())) {            throw new EtcException("crm.vehicle.boo2.already.active");        }        ReqActivationCheckDTO req = new ReqActivationCheckDTO();        req.setPlate(plate);        req.setRequest_id(System.currentTimeMillis());        req.setRequest_datetime(System.currentTimeMillis());        ResActivationCheckDTO res = boo1Service.findVehicleByPlateNumber(req, null, Constants.ACT_TYPE.BOO1_CHECK_VEHICLE);        if (res != null) {            if (Constants.BOO_STATUS.ACTIVE.equals(res.getStatus())) {                throw new EtcException("crm.vehicle.boo1.already.active");            }        } else {            throw new EtcException("crm.vehicle.boo1.connect.fail");        }        return ErrorApp.SUCCESS;    }    @Override    public Object getListProvinceById(Long id) {        return viettelPostService.getListProvinceById(id);    }    @Override    public Object getListDistrict(Long id) {        return viettelPostService.getListDistrict(id);    }    @Override    public Object getListWards(Long id) {        return viettelPostService.getListWards(id);    }    @Override    public Object getListShop() {        return viettelPostService.getListShop();    }    @Override    public Object getByOrderNumber(String orderNumber) {        return custRegisServiceJPA.getByOrderNumber(orderNumber);    }    @Override    public ConfirmOrderResDTO confirmOrder(ConfirmOrderDTO params, String remoteAddr) {        CustRegisEntity custRegisEntity = null;        VehicleEntity vehicleEntity = vehicleServiceJPA.getOne(params.getVehicleId());        if (vehicleEntity == null) {            throw new EtcException("crm.vehicle.not.found");        }        ContractEntity contractEntity = contractServiceJPA.getOne(vehicleEntity.getContractId());        if (!FnCommon.isNullOrBlank(params.getOrderNumber())) {            custRegisEntity = custRegisServiceJPA.getByOrderNumber(params.getOrderNumber());            if (custRegisEntity == null) {                throw new EtcException("order.number.not.exist");            }        } else {            params.setOrderNumber("");        }        Long cod;        if (custRegisEntity != null && CustRegisEntity.RegStatus.NEW.value.equals(custRegisEntity.getRegStatus())) {            cod = params.getContractPrice() + 20000L;        } else {            cod = params.getContractPrice();        }        String tranId = vehicleEntity.getRfidSerial();        ConfirmOrderResDTO responseDTO = viettelPostService.confirmOrder(params, remoteAddr, contractEntity, tranId, cod);        if (responseDTO.getErrorCode().equals(0) && custRegisEntity != null) {            custRegisEntity.setRegStatus(CustRegisEntity.RegStatus.SIGNED.value);            custRegisServiceJPA.save(custRegisEntity);        }        return responseDTO;    }    @Override    public Object getFeeAddVehicle(String plateNumber, String plateTypeCode) {        String status = vehicleService.checkVehicle(plateNumber, plateTypeCode);        ServiceFeeDTO serviceFee = (ServiceFeeDTO) serviceFeeService.getDetailServiceFeeByReason(Constants.ACT_REASON.ACTIVE_RFID);        Long fee = serviceFee.getFee();        Map<String, Long> result = new HashMap<>();        if (status == null) {            throw new EtcException("crm.vehicle.boo1.connect.fail");        }        if (Constants.BOO_STATUS.ACTIVE.equals(status)) {            throw new EtcException("crm.vehicle.already.active");        }        result.put("fee", 0L);        if (Calendar.getInstance().get(Calendar.YEAR) > 2021 || Constants.BOO_STATUS.DESTROY.equals(status)) {            result.put("fee", fee);        }        return result;    }}