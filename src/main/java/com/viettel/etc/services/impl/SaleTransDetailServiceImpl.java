package com.viettel.etc.services.impl;import com.google.gson.Gson;import com.viettel.etc.dto.*;import com.viettel.etc.repositories.SaleTransDetailRepository;import com.viettel.etc.repositories.tables.*;import com.viettel.etc.repositories.tables.entities.*;import com.viettel.etc.services.*;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.FnCommon;import com.viettel.etc.utils.exceptions.EtcException;import com.viettel.etc.xlibrary.core.constants.FunctionCommon;import com.viettel.etc.xlibrary.core.entities.ExcellDataEntity;import com.viettel.etc.xlibrary.core.entities.ExcellHeaderEntity;import com.viettel.etc.xlibrary.core.entities.ExcellSheet;import com.viettel.etc.xlibrary.core.entities.ResultSelectEntity;import lombok.extern.log4j.Log4j;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.security.core.Authentication;import org.springframework.stereotype.Service;import java.io.File;import java.io.IOException;import java.text.SimpleDateFormat;import java.time.LocalDateTime;import java.time.ZoneId;import java.time.format.DateTimeFormatter;import java.util.*;import java.util.stream.Collectors;import static com.viettel.etc.utils.Constants.COMMON_DATE_FORMAT;/** * Autogen class: Lich su mua ve * * @author ToolGen * @date Mon Jul 13 08:57:39 ICT 2020 */@Log4j@Servicepublic class SaleTransDetailServiceImpl implements SaleTransDetailService {    @Value("${ws.transactions.history.vehicle}")    private String transactionsHistoryUrl;    @Autowired    private SaleTransDetailRepository saleTransDetailRepository;    @Autowired    private StageService stageService;    @Autowired    private StationService stationService;    @Autowired    private VehicleGroupService vehicleGroupService;    @Autowired    private CategoriesService categoriesService;    @Autowired    private ServiceFeeRepositoryJPA serviceFeeRepositoryJPA;    @Autowired    private ServiceFeeService serviceFeeService;    @Autowired    private SaleTransDetailRepositoryJPA saleTransDetailRepositoryJPA;    @Autowired    private ContractRepositoryJPA contractRepositoryJPA;    @Autowired    private SaleTransDelBoo1RepositoryJPA saleTransDelBoo1RepositoryJPA;    @Autowired    private VehicleRepositoryJPA vehicleRepositoryJPA;    /**     * Tim kiem lich su mua ve     *     * @param vehicleId     * @param saleTransDetailDTO     * @param authentication     * @return     */    @Override    public Object searchTicketPurchaseHistories(Long vehicleId, SaleTransDetailDTO saleTransDetailDTO, Authentication authentication) {        ResultSelectEntity dataResult = saleTransDetailRepository.findTicketPurchaseHistories(vehicleId, saleTransDetailDTO);        List<Long> stageList = new ArrayList<>();        List<Long> stationList = new ArrayList<>();        List<SaleTransDetailDTO> saleTransDetailDTOList = (List<SaleTransDetailDTO>) dataResult.getListData();        getListStageAndStation(stageList, stationList, saleTransDetailDTOList);        //get list data stage and station from category        List<StageDTO.Stage> dataStages = stageService.findStagesByListId(FnCommon.getStringToken(authentication), stageList);        List<StationDTO.Station> dataStations = stationService.findStationsByListId(FnCommon.getStringToken(authentication), stationList);        Map<Long, String> stagesMap = dataStages.stream().collect(Collectors.toMap(StageDTO.Stage::getId, StageDTO.Stage::getName));        Map<Long, String> stationMap = dataStations.stream().collect(Collectors.toMap(StationDTO.Station::getId, StationDTO.Station::getName));        for (SaleTransDetailDTO saleTransDetailResult : saleTransDetailDTOList) {            if (saleTransDetailResult.getStationId() != null) {                saleTransDetailResult.setStation(stationMap.get(saleTransDetailResult.getStationId()));            }            if (saleTransDetailResult.getStageId() != null) {                saleTransDetailResult.setStage(stagesMap.get(saleTransDetailResult.getStageId()));            }        }        return dataResult;    }    /**     * Lich su mua ve App CPT     *     * @param saleTransDetailDTO     * @param authentication     * @return     */    @Override    public Object vehicleOwnerAppTicketPurchaseHistories(SaleTransDetailVehicleOwnerAppDTO saleTransDetailDTO, Authentication authentication) {        ContractEntity contractEntity = contractRepositoryJPA.getByAccountUser(FnCommon.getUserLogin(authentication));        if (FnCommon.isNullObject(contractEntity)) {            throw new EtcException("validate.data.not.invalid");        }        ResultSelectEntity dataResult = saleTransDetailRepository.vehicleOwnerAppTicketPurchaseHistories(saleTransDetailDTO, contractEntity.getContractId() );        List<Long> stageList = new ArrayList<>(); // danh sach doan        List<Long> stationList = new ArrayList<>();// danh sach tram        List<Long> vehicleGroupList = new ArrayList<>(); // lay danh sach nhom phuong tien thu phi        List<SaleTransDetailVehicleOwnerAppDTO> saleTransDetailDTOList = (List<SaleTransDetailVehicleOwnerAppDTO>) dataResult.getListData();        getListStageAndStationAndVehicleGroupName(stageList, stationList, vehicleGroupList, saleTransDetailDTOList);        //get list data stage, station, vehicle_group, categories from category        List<StageDTO.Stage> dataStages = stageService.findStagesByListId(FnCommon.getStringToken(authentication), stageList);        List<StationDTO.Station> dataStations = stationService.findStationsByListId(FnCommon.getStringToken(authentication), stationList);        List<VehicleGroupDTO.VehicleGroup> dataVehicleGroups = vehicleGroupService.findVehicleGroupByListId(FnCommon.getStringToken(authentication), vehicleGroupList);        CategoryDTO.Categories dataCategories = categoriesService.findCategoriesByListId(FnCommon.getStringToken(authentication), Constants.METHOD_CHARGE);        Map<Long, String> stagesMap = dataStages.stream().collect(Collectors.toMap(StageDTO.Stage::getId, StageDTO.Stage::getName));        Map<Long, String> stationMap = dataStations.stream().collect(Collectors.toMap(StationDTO.Station::getId, StationDTO.Station::getName));        Map<Long, Long> stationMapMethodCharge = dataStations.stream().collect(Collectors.toMap(StationDTO.Station::getId, StationDTO.Station::getMethod_charge_id));        Map<Long, Long> stagesMapMethodCharge = dataStages.stream().collect(Collectors.toMap(StageDTO.Stage::getId, StageDTO.Stage::getMethod_charge_id));        Map<Long, String> vehicleGroupMap = dataVehicleGroups.stream().collect(Collectors.toMap(VehicleGroupDTO.VehicleGroup::getId, VehicleGroupDTO.VehicleGroup::getName));        Map<Long, String> categoriesMap = dataCategories.getListData().stream().collect(Collectors.toMap(CategoryDTO.Category::getCode, CategoryDTO.Category::getName));        for (SaleTransDetailVehicleOwnerAppDTO saleTransDetailResult : saleTransDetailDTOList) {            if (saleTransDetailResult.getStationId() != null) {                saleTransDetailResult.setStation(stationMap.get(saleTransDetailResult.getStationId()));                saleTransDetailResult.setMethodCharge(categoriesMap.get(stationMapMethodCharge.get(saleTransDetailResult.getStationId())));            }            if (saleTransDetailResult.getStageId() != null) {                saleTransDetailResult.setStage(stagesMap.get(saleTransDetailResult.getStageId()));                saleTransDetailResult.setMethodCharge(categoriesMap.get(stagesMapMethodCharge.get(saleTransDetailResult.getStageId())));            }            if (saleTransDetailResult.getVehicleGroupId() != null) {                saleTransDetailResult.setVehicleGroupName(vehicleGroupMap.get(saleTransDetailResult.getVehicleGroupId()));            }        }        return dataResult;    }    /***     * Lich su ve dang hieu luc     * @param req     * @param authentication     * @return     */    @Override    public Object searchTicketPurchaseEfficiencyHistories(SaleTranTicketsDTO req, Authentication authentication) {        ResultSelectEntity dataResult = saleTransDetailRepository.searchTicketPurchaseEfficiencyHistories(req);        List<Long> stageList = new ArrayList<>(); // danh sach doan        List<Long> stationList = new ArrayList<>();// danh sach tram        List<Long> vehicleGroupList = new ArrayList<>(); // lay danh sach nhom phuong tien thu phi        List<SaleTransDetailDTO> saleTransDetailDTOList = (List<SaleTransDetailDTO>) dataResult.getListData();        getListStageAndStation(stageList, stationList, vehicleGroupList, saleTransDetailDTOList);        //get list data stage, station, vehicle_group, categories from category        List<StageDTO.Stage> dataStages = stageService.findStagesByListId(FnCommon.getStringToken(authentication), stageList);        List<StationDTO.Station> dataStations = stationService.findStationsByListId(FnCommon.getStringToken(authentication), stationList);        CategoryDTO.Categories dataCategories = categoriesService.findCategoriesByListId(FnCommon.getStringToken(authentication), Constants.METHOD_CHARGE);        Map<Long, String> stagesMap = dataStages.stream().collect(Collectors.toMap(StageDTO.Stage::getId, StageDTO.Stage::getName));        Map<Long, String> stationMap = dataStations.stream().collect(Collectors.toMap(StationDTO.Station::getId, StationDTO.Station::getName));        Map<Long, Long> stationMapMethodCharge = dataStations.stream().collect(Collectors.toMap(StationDTO.Station::getId, StationDTO.Station::getMethod_charge_id));        Map<Long, Long> stagesMapMethodCharge = dataStages.stream().collect(Collectors.toMap(StageDTO.Stage::getId, StageDTO.Stage::getMethod_charge_id));        Map<Long, String> categoriesMap = dataCategories.getListData().stream().collect(Collectors.toMap(CategoryDTO.Category::getCode, CategoryDTO.Category::getName));        List<Long> subSubscriptionTicketIds = new ArrayList<>();        for (SaleTransDetailDTO saleTransDetailResult : saleTransDetailDTOList) {            if (saleTransDetailResult.getStationId() != null) {                saleTransDetailResult.setStation(stationMap.get(saleTransDetailResult.getStationId()));                saleTransDetailResult.setChargeMethodName(categoriesMap.get(stationMapMethodCharge.get(saleTransDetailResult.getStationId())));            }            if (saleTransDetailResult.getStageId() != null) {                saleTransDetailResult.setStage(stagesMap.get(saleTransDetailResult.getStageId()));                saleTransDetailResult.setChargeMethodName(categoriesMap.get(stagesMapMethodCharge.get(saleTransDetailResult.getStageId())));            }            Long subTicketId = ticketIssued(authentication, saleTransDetailResult);            if (subTicketId != null && subTicketId != 0){                subSubscriptionTicketIds.add(subTicketId);            }        }        saleTransDetailDTOList.removeAll(subSubscriptionTicketIds);        return dataResult;    }    /***     * Kiem tra ve da duoc su dung hay chua?     * @param authentication     * @param saleTransDetailResult     * @return     */    private Long ticketIssued(Authentication authentication, SaleTransDetailDTO saleTransDetailResult) {        Map<String, String> map = new HashMap<>();        if (saleTransDetailResult.getStageId() != null && saleTransDetailResult.getStageId() != 0) {            map.put("stationType", "0");            List<StageDTO.Stage> dataStages = stageService.findStagesByListId(FnCommon.getStringToken(authentication), Arrays.asList(saleTransDetailResult.getStageId()));            if (FnCommon.isNullOrEmpty(dataStages)) {                throw new EtcException("common.validate.data.empty");            }            map.put("stationInId", dataStages.get(0).getStationIn().getId().toString());            map.put("stationOutId", dataStages.get(0).getStationOut().getId().toString());            map.put("timestampOutFrom", saleTransDetailResult.getEffDate());            Date date = new Date(saleTransDetailResult.getEffDate());            LocalDateTime localDateTime = date.toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime();            map.put("timestampOutTo", DateTimeFormatter.ofPattern("dd/MM/yyyy").format(localDateTime.plusDays(29)));        } else {            map.put("stationType", "1");            map.put("stationInId", saleTransDetailResult.getStationId().toString());            map.put("timestampInFrom", saleTransDetailResult.getEffDate());            Date date = new Date(saleTransDetailResult.getEffDate());            LocalDateTime localDateTime = date.toInstant().atZone(ZoneId.systemDefault()).toLocalDateTime();            map.put("timestampInTo", DateTimeFormatter.ofPattern("dd/MM/yyyy").format(localDateTime.plusDays(29)));        }        map.put("code", saleTransDetailResult.getPlateNumber());        map.put("pagesize", "10");        map.put("startrecord", "0");        String responseTransactionsHistory = FnCommon.doGetRequest(transactionsHistoryUrl, map, FnCommon.getStringToken(authentication));        try {            TransactionsHistoryVehicleDTO trans = new Gson().fromJson(responseTransactionsHistory, TransactionsHistoryVehicleDTO.class);            if (!FnCommon.isNullObject(trans) && !FnCommon.isNullObject(trans.getData())) {                TransactionsHistoryVehicleDTO.TransactionsHistoryList datas = trans.getData();                Optional<TransactionsHistoryVehicleDTO.TransactionsHistory> result = datas.getListData().stream().parallel().filter(transactionsHistory -> transactionsHistory.getTicketId().equals(saleTransDetailResult.getSubscriptionTicketId())).findAny();                return result.isPresent() ? saleTransDetailResult.getSubscriptionTicketId() : 0L;            }        } catch (Exception e) {            log.error(e);            return 0L;        }        return 0L;    }    /**     * Export file excel lich su mua ve     *     * @param saleTransDetailDTO     * @param authentication     * @return     */    public String exportTicketPurchaseHistories(SaleTransDetailVehicleOwnerAppDTO saleTransDetailDTO, Authentication authentication) {        try {                String fileName = "TicketPurchaseHistories" + System.currentTimeMillis() + ".xlsx";            SimpleDateFormat formatter = new SimpleDateFormat(COMMON_DATE_FORMAT);            String date = formatter.format(new Date());            String title = "Lịch sử mua vé tháng quý \nNgày xuất " + date;            ResultSelectEntity resultSelectEntity = (ResultSelectEntity) vehicleOwnerAppTicketPurchaseHistories(saleTransDetailDTO, authentication);            List<SaleTransDetailVehicleOwnerAppDTO> saleTransDetailDTOList = (List<SaleTransDetailVehicleOwnerAppDTO>) resultSelectEntity.getListData();            ExcellSheet sheetExport = new ExcellSheet();            //set header            List<ExcellHeaderEntity> listHeader = new ArrayList<>();            listHeader.add(new ExcellHeaderEntity("Mã GD"));            listHeader.add(new ExcellHeaderEntity("Biển số xe"));            listHeader.add(new ExcellHeaderEntity("Trạm/ đoạn"));            listHeader.add(new ExcellHeaderEntity("Loại vé"));            listHeader.add(new ExcellHeaderEntity("Loại giá vé"));            listHeader.add(new ExcellHeaderEntity("Số tiền"));            listHeader.add(new ExcellHeaderEntity("Ngày mua"));            listHeader.add(new ExcellHeaderEntity("Người mua"));            listHeader.add(new ExcellHeaderEntity("Từ ngày"));            listHeader.add(new ExcellHeaderEntity("Đến ngày"));            listHeader.add(new ExcellHeaderEntity("GHTĐ"));            listHeader.add(new ExcellHeaderEntity("Hiệu lực"));            sheetExport.setListHeader(listHeader);            ExcellDataEntity excellDataEntity = new ExcellDataEntity();            List<List<Object>> listData = new ArrayList<>();            //set data            for (SaleTransDetailVehicleOwnerAppDTO saleTransDetail : saleTransDetailDTOList) {                List<Object> objectList = new ArrayList<>();                objectList.add(saleTransDetail.getSaleTransCode());                objectList.add(saleTransDetail.getPlateNumber());                objectList.add(saleTransDetail.getStation() == null ? saleTransDetail.getStage() : saleTransDetail.getStation());                objectList.add(saleTransDetail.getServicePlanTypeName());                objectList.add(saleTransDetail.getMethodCharge());                objectList.add(saleTransDetail.getPrice());                objectList.add(saleTransDetail.getSaleTransDate());                objectList.add(saleTransDetail.getCreateUser());                objectList.add(saleTransDetail.getEffDate());                objectList.add(saleTransDetail.getExpDate());                objectList.add("1".equals(saleTransDetail.getAutoRenew()) ? "Có" : "Không");                objectList.add(saleTransDetail.getEfficiency().equals(1L) ? "Có hiệu lực" : "Hết hiệu lực");                listData.add(objectList);            }            excellDataEntity.setListData(listData);            sheetExport.setExcellDataEntity(excellDataEntity);            //export excel            if (!FunctionCommon.exportFileExcell(sheetExport, System.getProperty("user.dir") + File.separator + fileName, title)) {                throw new IOException();            }            return fileName;        } catch (Exception ex) {            log.error("Export Fail", ex);        }        return null;    }    /**     * Lay danh sach tram va doan     *     * @param stageList     * @param stationList     * @param saleTransDetailDTOList     */    private void getListStageAndStation(List<Long> stageList, List<Long> stationList, List<SaleTransDetailDTO> saleTransDetailDTOList) {        for (SaleTransDetailDTO result : saleTransDetailDTOList) {            if (result.getStageId() != null) {                stageList.add(result.getStageId());            }            if (result.getStationId() != null) {                stationList.add(result.getStationId());            }        }    }    /**     * Lay danh sach tram doan va ten nhom phuong tien     *     * @param stageList     * @param stationList     * @param vehicleGroupList     * @param saleTransDetailDTOList     */    private void getListStageAndStationAndVehicleGroupName(List<Long> stageList, List<Long> stationList, List<Long> vehicleGroupList, List<SaleTransDetailVehicleOwnerAppDTO> saleTransDetailDTOList) {        for (SaleTransDetailVehicleOwnerAppDTO result : saleTransDetailDTOList) {            if (result.getStageId() != null) {                stageList.add(result.getStageId());            }            if (result.getStationId() != null) {                stationList.add(result.getStationId());            }            if (result.getVehicleGroupId() != null) {                vehicleGroupList.add(result.getVehicleGroupId());            }        }    }    private void getListStageAndStation(List<Long> stageList, List<Long> stationList, List<Long> vehicleGroupList, List<SaleTransDetailDTO> saleTransDetailDTOList) {        for (SaleTransDetailDTO result : saleTransDetailDTOList) {            if (result.getStageId() != null) {                stageList.add(result.getStageId());            }            if (result.getStationId() != null) {                stationList.add(result.getStationId());            }        }    }    /**     * Them chi tiet giao dich     *     * @param actTypeId     * @param saleTransId     * @param authentication     * @return     */    @Override    public void addSaleTransDetail(Authentication authentication, Long saleTransId, Long vehicleId, Long actTypeId) {        List<ServiceFeeEntity> serviceFeeEntityList = serviceFeeRepositoryJPA.getByActTypeId(actTypeId);        if (serviceFeeEntityList.size() == 0) {            return;        }        ServiceFeeEntity serviceFeeEntity = serviceFeeEntityList.get(0);        SaleTransDetailEntity saleTransDetailEntity = new SaleTransDetailEntity();        saleTransDetailEntity.setCreateDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setPrice(serviceFeeEntity.getFee());        saleTransDetailEntity.setServiceFeeId(serviceFeeEntity.getServiceFeeId());        saleTransDetailEntity.setServiceFeeName(serviceFeeEntity.getServiceFeeName());        saleTransDetailEntity.setSaleTransId(saleTransId);        saleTransDetailEntity.setSaleTransDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setQuantity(Long.parseLong("1"));        saleTransDetailEntity.setCreateUser(FnCommon.getUserLogin(authentication));        saleTransDetailEntity.setCreateDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setStatus(SaleTransDetailEntity.Status.PAID_NOT_INVOICED.value);        if(vehicleId != null) {            VehicleEntity vehicleEntity = vehicleRepositoryJPA.findByVehicleId(vehicleId);            if(vehicleEntity != null) {                saleTransDetailEntity.setVehicleId(vehicleId);                saleTransDetailEntity.setPlateNumber(vehicleEntity.getPlateNumber());                saleTransDetailEntity.setEpc(vehicleEntity.getEpc());                saleTransDetailEntity.setRfidSerial(vehicleEntity.getRfidSerial());                saleTransDetailEntity.setTid(vehicleEntity.getTid());            }        }        saleTransDetailRepositoryJPA.save(saleTransDetailEntity);    }    @Override    public void addSaleTransDetailAddVehicle(Authentication authentication, Long saleTransId, Long vehicleId, Long fee, ServiceFeeDTO serviceFee) {        SaleTransDetailEntity saleTransDetailEntity = new SaleTransDetailEntity();        saleTransDetailEntity.setCreateDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setPrice(fee);        saleTransDetailEntity.setServiceFeeId(serviceFee.getServiceFeeId());        saleTransDetailEntity.setServiceFeeName(serviceFee.getServiceFeeName());        saleTransDetailEntity.setSaleTransId(saleTransId);        saleTransDetailEntity.setSaleTransDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setQuantity(Long.parseLong("1"));        saleTransDetailEntity.setCreateUser(FnCommon.getUserLogin(authentication));        saleTransDetailEntity.setCreateDate(new java.sql.Date(System.currentTimeMillis()));        saleTransDetailEntity.setStatus(SaleTransDetailEntity.Status.PAID_NOT_INVOICED.value);        if(vehicleId != null) {            VehicleEntity vehicleEntity = vehicleRepositoryJPA.findByVehicleId(vehicleId);            if(vehicleEntity != null) {                saleTransDetailEntity.setVehicleId(vehicleId);                saleTransDetailEntity.setPlateNumber(vehicleEntity.getPlateNumber());                saleTransDetailEntity.setEpc(vehicleEntity.getEpc());                saleTransDetailEntity.setRfidSerial(vehicleEntity.getRfidSerial());                saleTransDetailEntity.setTid(vehicleEntity.getTid());                saleTransDetailEntity.setVehicleGroupId(vehicleEntity.getVehicleGroupId());            }        }        saleTransDetailRepositoryJPA.save(saleTransDetailEntity);    }    /**     * Lay danh sach ve da mua de huy ve khong hoan tien     *     * @param saleTranTicketsDTO     * @param authentication     * @return     */    @Override    public Object searchTicketHistories(SaleTranTicketsDTO saleTranTicketsDTO, Authentication authentication) {        ResultSelectEntity dataResult = saleTransDetailRepository.searchTicketHistories(saleTranTicketsDTO);        return dataResult;    }}