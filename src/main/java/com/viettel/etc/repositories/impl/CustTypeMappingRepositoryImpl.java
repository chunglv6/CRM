package com.viettel.etc.repositories.impl;import com.viettel.etc.dto.CustTypeMappingDTO;import com.viettel.etc.repositories.CustTypeMappingRepository;import com.viettel.etc.repositories.tables.entities.CustIdTypeMappingEntity;import com.viettel.etc.services.tables.CustIdTypeMappingServiceJPA;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.exceptions.EtcException;import com.viettel.etc.utils.FnCommon;import com.viettel.etc.xlibrary.core.repositories.CommonDataBaseRepository;import com.viettel.etc.xlibrary.core.entities.ResultSelectEntity;import java.sql.Date;import org.modelmapper.ModelMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.Authentication;import org.springframework.stereotype.Repository;import java.util.HashMap;/** * Autogen class Repository Impl: Chung tu cho loai khach hang *  * @author ToolGen * @date Tue Sep 08 11:35:14 ICT 2020 */@Repositorypublic class CustTypeMappingRepositoryImpl extends CommonDataBaseRepository implements CustTypeMappingRepository{    @Autowired    private CustIdTypeMappingServiceJPA custIdTypeMappingServiceJPA;    /**     * Lay danh sach chung tu cho loai khach hang     *      * @param itemParamsEntity: params client truyen len     * @return      */    @Override    public ResultSelectEntity find(CustTypeMappingDTO itemParamsEntity) {        StringBuilder sql = new StringBuilder();        sql.append("select a.ID, a.CUST_TYPE_ID as custTypeId, a.DOCUMENT_TYPE_ID as documentTypeId,")                .append("a.CREATE_DATE as createDate, a.description, a.status \n ")                .append(", b.NAME as custTypeName \n")                .append(", c.NAME as documentTypeName\n")                .append(", c.CODE as documentTypeCode\n")                .append("from CUST_ID_TYPE_MAPPING a \n")                .append("inner join CUST_TYPE b on a.CUST_TYPE_ID = b.CUST_TYPE_ID \n")                .append("inner join DOCUMENT_TYPE c on a.DOCUMENT_TYPE_ID = c.DOCUMENT_TYPE_ID \n")                .append("where 1=1 \n");        HashMap<String, Object> hmapParams = new HashMap<>();        if (itemParamsEntity.getDocumentTypeId() != null) {            sql.append("and a.DOCUMENT_TYPE_ID =:documentTypeId \n");            hmapParams.put("documentTypeId", itemParamsEntity.getDocumentTypeId());        }        if (itemParamsEntity.getCustTypeId() != null) {            sql.append("and a.CUST_TYPE_ID =:custTypeId \n");            hmapParams.put("custTypeId", itemParamsEntity.getCustTypeId());        }        if (itemParamsEntity.getStatus() != null) {            sql.append("and a.STATUS =:status \n");            hmapParams.put("status", itemParamsEntity.getStatus());        }        sql.append("order by a.UPDATE_DATE,a.CREATE_DATE \n");        Integer start = null;        if (itemParamsEntity.getStartrecord() != null) {            start = itemParamsEntity.getStartrecord();        }        Integer pageSize = null;        if (itemParamsEntity.getPagesize() != null) {            pageSize = itemParamsEntity.getPagesize();        }        return getListDataAndCount(sql, hmapParams, start, pageSize, CustTypeMappingDTO.class);    }    // thêm mới cấu hình    @Override    public Object insert(CustTypeMappingDTO params, Authentication authentication) throws EtcException, Exception {        if(custIdTypeMappingServiceJPA.existsByCustTypeIdAndDocumentTypeId(params.getCustTypeId(),params.getDocumentTypeId())){            throw  new EtcException("crm.validate.cust.type.mapping.exits");        }        Date date = new Date(System.currentTimeMillis());        String userLogin = FnCommon.getUserLogin(authentication);        ModelMapper modelMapper = new ModelMapper();        CustIdTypeMappingEntity obj = modelMapper.map(params, CustIdTypeMappingEntity.class);        obj.setCreateDate(date);        obj.setCreateUser(userLogin);        obj.setDescription(params.getDescription().trim());        return custIdTypeMappingServiceJPA.save(obj);    }    // lấy 1    @Override    public ResultSelectEntity findOne(Long id) {        StringBuilder sql = new StringBuilder();        HashMap<String, Object> hmapParams = new HashMap<>();        sql.append("select ID, CUST_TYPE_ID as custTypeId, DOCUMENT_TYPE_ID as documentTypeId, \n")                .append("DESCRIPTION, STATUS \n")                .append(" from CUST_ID_TYPE_MAPPING where id =:id");        hmapParams.put("id",id);        return getListDataAndCount(sql, hmapParams, 0, 1, CustTypeMappingDTO.class);    }    //    cập nhật trạng thái cấu hình    @Override    public Object updateStatus (Long id,Authentication authentication)  throws EtcException, Exception {        Date date = new Date(System.currentTimeMillis());        String userLogin = FnCommon.getUserLogin(authentication);        CustIdTypeMappingEntity obj = custIdTypeMappingServiceJPA.findById(id).get();        obj.setUpdateDate(date);        obj.setUpdateUser(userLogin);        if(obj.getStatus().equals(Constants.CATEGORY_STATUS.ACTIVE)){            obj.setStatus(Constants.CATEGORY_STATUS.INACTIVE);        }else{            obj.setStatus(Constants.CATEGORY_STATUS.ACTIVE);        }        return custIdTypeMappingServiceJPA.save(obj);    }}