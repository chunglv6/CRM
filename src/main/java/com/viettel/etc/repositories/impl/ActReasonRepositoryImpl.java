package com.viettel.etc.repositories.impl;import com.viettel.etc.dto.ActReasonDTO;import com.viettel.etc.repositories.ActReasonRepository;import com.viettel.etc.repositories.tables.entities.ActReasonEntity;import com.viettel.etc.services.tables.ActReasonServiceJPA;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.exceptions.EtcException;import com.viettel.etc.utils.FnCommon;import com.viettel.etc.xlibrary.core.entities.ResultSelectEntity;import com.viettel.etc.xlibrary.core.repositories.CommonDataBaseRepository;import org.modelmapper.ModelMapper;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.core.Authentication;import org.springframework.stereotype.Repository;import java.sql.Date;import java.util.HashMap;import java.util.List;/** * Autogen class Repository Impl: Ly do tac dong * * @author ToolGen * @date Sat Sep 05 08:50:20 ICT 2020 */@Repositorypublic class ActReasonRepositoryImpl extends CommonDataBaseRepository implements ActReasonRepository {    @Autowired    private ActReasonServiceJPA actReasonServiceJPA;    /**     * Lay danh sach ly do tac dong     *     * @param itemParamsEntity: params client truyen len     * @return     */    @Override    public ResultSelectEntity find(ActReasonDTO itemParamsEntity) {        StringBuilder sql = new StringBuilder();        sql.append("select a.NAME,a.CODE, a.ACT_REASON_ID as actReasonId ,a.ACT_TYPE_ID as actTypeId,a.CREATE_DATE as createDate,a.DESCRIPTION,a.STATUS, b.NAME as actTypeName \n ")                .append("from ACT_REASON  a \n")                .append("inner join ACT_TYPE  b on a.ACT_TYPE_ID = b.ACT_TYPE_ID \n")                .append("where 1=1 \n");        HashMap<String, Object> hmapParams = new HashMap<>();        if (!FnCommon.isNullOrEmpty(itemParamsEntity.getCode())) {            sql.append("and LOWER(a.CODE) like :code \n");            hmapParams.put("code", "%" + itemParamsEntity.getCode().toLowerCase().trim() + "%");        }        if (!FnCommon.isNullOrEmpty(itemParamsEntity.getName())) {            sql.append("and LOWER(a.NAME) like :name \n");            hmapParams.put("name", "%" + itemParamsEntity.getName().toLowerCase().trim() + "%");        }        if (itemParamsEntity.getStatus() != null) {            sql.append("and a.STATUS =:status \n");            hmapParams.put("status", itemParamsEntity.getStatus());        }        if (itemParamsEntity.getActTypeId() != null) {            sql.append("and a.ACT_TYPE_ID =:actTypeId \n");            hmapParams.put("actTypeId", itemParamsEntity.getActTypeId());        }        sql.append("order by NLSSORT(b.NAME, 'nls_sort = Vietnamese'),NLSSORT(a.NAME, 'nls_sort = Vietnamese') \n");        Integer start = null;        if (itemParamsEntity.getStartrecord() != null) {            start = itemParamsEntity.getStartrecord();        }        Integer pageSize = null;        if (itemParamsEntity.getPagesize() != null) {            pageSize = itemParamsEntity.getPagesize();        }        return getListDataAndCount(sql, hmapParams, start, pageSize, ActReasonDTO.class);    }    // thêm mới act-reason    @Override    public Object insert(ActReasonDTO params, Authentication authentication) {        List<ActReasonEntity> listCheck = actReasonServiceJPA.findAllByCodeAndStatus(params.getCode(), Constants.ACT_REASON_ACTIVE);        if (listCheck.size() > Constants.SIZE_LIST_ZERO && params.getStatus().equals(Constants.ACT_REASON_ACTIVE)) {            throw new EtcException("crm.validate.act.reason.exits");        }        ModelMapper modelMapper = new ModelMapper();        ActReasonEntity obj = modelMapper.map(params, ActReasonEntity.class);        obj.setCreateDate(new Date(System.currentTimeMillis()));        obj.setCreateUser(FnCommon.getUserLogin(authentication));        obj.setCode(params.getCode().trim());        obj.setName(params.getName().trim());        return actReasonServiceJPA.save(obj);    }    // update act-reason    @Override    public Object update(ActReasonDTO param, Authentication authentication) {        List<ActReasonEntity> listCheck = actReasonServiceJPA.findAllByCodeAndStatus(param.getCode(), Constants.ACT_REASON_ACTIVE);        if (listCheck.size() > Constants.SIZE_LIST_ZERO && param.getStatus().equals(Constants.ACT_REASON_ACTIVE)) {            throw new EtcException("crm.validate.act.reason.exits");        }        ActReasonEntity obj = actReasonServiceJPA.findById(param.getActReasonId()).get();        obj.setUpdateDate(new Date(System.currentTimeMillis()));        obj.setUpdateUser(FnCommon.getUserLogin(authentication));        obj.setCode(param.getCode().trim());        obj.setName(param.getName().trim());        obj.setActTypeId(param.getActTypeId());        obj.setStatus(param.getStatus());        obj.setDescription(param.getDescription());        return actReasonServiceJPA.save(obj);    }    // lấy 1    @Override    public ResultSelectEntity findOne(Long actReasonId) {        StringBuilder sql = new StringBuilder();        HashMap<String, Object> hmapParams = new HashMap<>();        sql.append("select NAME,CODE, ACT_REASON_ID as actReasonId ,ACT_TYPE_ID as actTypeId,CREATE_DATE as createDate,DESCRIPTION,STATUS from ACT_REASON where ACT_REASON_ID =:actReasonId");        hmapParams.put("actReasonId", actReasonId);        return getListDataAndCount(sql, hmapParams, 0, 1, ActReasonDTO.class);    }}