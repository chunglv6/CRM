package com.viettel.etc.repositories.impl;import com.viettel.etc.dto.SaleTranTicketsDTO;import com.viettel.etc.dto.SaleTransDetailDTO;import com.viettel.etc.dto.SaleTransDetailVehicleOwnerAppDTO;import com.viettel.etc.repositories.SaleTransDetailRepository;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.FnCommon;import com.viettel.etc.xlibrary.core.entities.ResultSelectEntity;import com.viettel.etc.xlibrary.core.repositories.CommonDataBaseRepository;import org.springframework.stereotype.Repository;import java.util.ArrayList;import java.util.List;/** * Autogen class Repository Impl: Lich su mua ve * * @author ToolGen * @date Mon Jul 13 08:57:39 ICT 2020 */@Repositorypublic class SaleTransDetailRepositoryImpl extends CommonDataBaseRepository implements SaleTransDetailRepository {    /**     * Tim kiem lich su mua ve     *     * @param vehicleId     * @param saleTransDetailDTO     * @return     */    @Override    public ResultSelectEntity findTicketPurchaseHistories(Long vehicleId, SaleTransDetailDTO saleTransDetailDTO) {        StringBuilder sql = new StringBuilder();        List<Object> arrParams = new ArrayList<>();        sql.append("select ");        sql.append("    std.SALE_TRANS_ID                           as saleTransId,         -- sale trans id \n");        sql.append("    st.SALE_TRANS_CODE                          as saleTransCode,       -- Ma giao dich \n");        sql.append("    std.STATION_ID                              as stationId,           -- Ma tram \n");        sql.append("    std.STAGE_ID                                as stageId,             --Ma doan \n");        sql.append("    std.SERVICE_PLAN_TYPE_ID                    as servicePlanTypeId,   -- Ma loai ve \n");        sql.append("    spt.NAME                                    as servicePlanTypeName, -- Loai ve \n");        sql.append("    std.PRICE                                   as price,               -- So tien \n");        sql.append("    std.STATUS                                  as status,              -- Trang thai \n");        sql.append("    to_char(std.SALE_TRANS_DATE, 'dd/MM/yyyy HH24:mi:ss')  as saleTransDate,       -- Ngay mua  (dd/MM/yyyy HH24:mi:ss)\n");        sql.append("    to_char(std.EFF_DATE, 'dd/mm/yyyy')         as effDate,             -- Tu ngay  (dd/mm/yyyy)\n");        sql.append("    to_char(std.EXP_DATE, 'dd/mm/yyyy')         as expDate,             -- Den ngay  (dd/mm/yyyy)\n");        sql.append("    st.CREATE_USER                              as accountOwner,        -- Nguoi mua \n");        sql.append("    std.AUTO_RENEW                              as autoRenew,           -- Gia han tu dong \n");        sql.append("    sl.CHARGE_METHOD_ID                         as chargeMethodId,      -- Phuong thuc tinh phi \n");        sql.append("    st.PAYMENT_METHOD_ID                        as paymentMethodId,     -- Phuong thuc thanh toan \n");        sql.append("    case\n");        sql.append("    when to_date(sysdate, 'dd/mm/yyyy') BETWEEN TO_DATE(std.EFF_DATE, 'dd/mm/yyyy') AND TO_DATE(std.EXP_DATE, 'dd/mm/yyyy') then 1\n");        sql.append("    else 0\n");        sql.append("    end as efficiency\n");        sql.append(" from SALE_TRANS_DETAIL std, SALE_TRANS st, SERVICE_PLAN_TYPE spt, SERVICE_PLAN sl \n");        sql.append(" where std.SALE_TRANS_ID = st.SALE_TRANS_ID (+) \n");        sql.append(" and std.SERVICE_PLAN_TYPE_ID = spt.SERVICE_PLAN_TYPE_ID (+) \n");        sql.append(" and std.SERVICE_PLAN_ID = sl.SERVICE_PLAN_ID (+) \n");        // sale trans type 2 is ticket histories        sql.append(" and st.SALE_TRANS_TYPE = 2\n");        if (vehicleId != null) {            sql.append(" and std.VEHICLE_ID = ? \n");            arrParams.add(vehicleId);        }        if (saleTransDetailDTO.getStationId() != null) {            sql.append(" and std.STATION_ID = ? \n");            arrParams.add(saleTransDetailDTO.getStationId());        }        if (saleTransDetailDTO.getStageId() != null) {            sql.append(" and std.STAGE_ID = ? \n");            arrParams.add(saleTransDetailDTO.getStageId());        }        if (saleTransDetailDTO.getServicePlanTypeId() != null) {            sql.append(" and std.SERVICE_PLAN_TYPE_ID = ? \n");            arrParams.add(saleTransDetailDTO.getServicePlanTypeId());        }        if (saleTransDetailDTO.getEfficiencyId() != null && saleTransDetailDTO.getEfficiencyId() == 1) {            sql.append(" and to_date(sysdate, 'dd/mm/yyyy') BETWEEN TO_DATE(std.EFF_DATE, 'dd/mm/yyyy') AND TO_DATE(std.EXP_DATE, 'dd/mm/yyyy')\n");        }        if (saleTransDetailDTO.getEfficiencyId() != null && saleTransDetailDTO.getEfficiencyId() == 2) {            sql.append(" and to_date(sysdate, 'dd/mm/yyyy') NOT BETWEEN TO_DATE(std.EFF_DATE, 'dd/mm/yyyy') AND TO_DATE(std.EXP_DATE, 'dd/mm/yyyy')\n");        }        if (!FnCommon.isNullOrEmpty(saleTransDetailDTO.getSaleTransDateFrom())) {            sql.append(" and to_date(?, 'dd/MM/yyyy') <= std.SALE_TRANS_DATE\n");            arrParams.add(saleTransDetailDTO.getSaleTransDateFrom());        }        if (!FnCommon.isNullOrEmpty(saleTransDetailDTO.getSaleTransDateTo())) {            sql.append(" and to_date(?, 'dd/MM/yyyy HH24:mi:ss') >= std.SALE_TRANS_DATE\n");            arrParams.add(saleTransDetailDTO.getSaleTransDateTo() + Constants.TIME_ONE_DAY);        }        sql.append(" order by std.SALE_TRANS_DATE desc");        /*        ==========================================================        Add param and query        ==========================================================        */        Integer start = 0;        if (saleTransDetailDTO != null && saleTransDetailDTO.getStartrecord() != null) {            start = saleTransDetailDTO.getStartrecord();        }        Integer pageSize = null;        if (saleTransDetailDTO != null && saleTransDetailDTO.getPagesize() != null) {            pageSize = saleTransDetailDTO.getPagesize();        }        ResultSelectEntity listData = getListDataAndCount(sql, arrParams, start, pageSize, SaleTransDetailDTO.class);        return listData;    }    /**     * Tim kiem lich su mua ve App CPT     *     * @param saleTransDetailVehicleOwnerAppDTO     * @param contractId     * @return     */    @Override    public ResultSelectEntity vehicleOwnerAppTicketPurchaseHistories(SaleTransDetailVehicleOwnerAppDTO saleTransDetailVehicleOwnerAppDTO, Long contractId) {        StringBuilder sql = new StringBuilder();        List<Object> arrParams = new ArrayList<>();        sql.append("select * from ( \n");        sql.append(" select ");        sql.append("    ST.SALE_TRANS_CODE                          as saleTransCode,       -- Ma giao dich \n");        sql.append("    std.STATION_ID                              as stationId,           -- Ma tram \n");        sql.append("    std.STAGE_ID                                as stageId,             --Ma doan \n");        sql.append("    std.SERVICE_PLAN_TYPE_ID                    as servicePlanTypeId,   -- Ma loai ve \n");        sql.append("    spt.NAME                                    as servicePlanTypeName, -- Loai ve \n");        sql.append("    std.PRICE                                   as price,               -- So tien \n");        sql.append("    std.VEHICLE_GROUP_ID                        as vehicleGroupId,      -- Ma phuong tien thu phi \n");        sql.append("    std.STATUS                                  as status,              -- Trang thai \n");        sql.append("    std.PLATE_NUMBER                            as plateNumber,         -- Bien so xe \n");        sql.append("    to_char((from_tz(to_timestamp(to_char(std.SALE_TRANS_DATE, 'dd/MM/yyyy HH24:mi:ss'), 'dd/MM/yyyy HH24:mi:ss') ,'07:00') at time zone 'Asia/Saigon'),'yyyy-MM-dd\"T\"HH24:MI:SS\"+07:00\"')  as saleTransDate,       -- Ngay mua  (dd/mm/yyyy)\n");        sql.append("    to_char(std.EFF_DATE, 'dd/mm/yyyy')         as effDate,             -- Tu ngay  (dd/mm/yyyy)\n");        sql.append("    to_char(std.EXP_DATE, 'dd/mm/yyyy')         as expDate,             -- Den ngay  (dd/mm/yyyy)\n");        sql.append("    st.ACCOUNT_OWNER                            as accountOwner,        -- Nguoi mua \n");        sql.append("    std.AUTO_RENEW                              as autoRenew,            -- Gia han tu dong \n");        sql.append("    st.CREATE_USER                              as createUser,           -- Nguoi mua ve \n");        sql.append("    case\n");        sql.append("    when sysdate > std.EFF_DATE AND sysdate < std.EXP_DATE \n");        sql.append("        OR sysdate < std.EFF_DATE \n");        sql.append("    then 1\n");        sql.append("    else 0\n");        sql.append("    end as efficiency\n");        sql.append(" from (select SALE_TRANS_ID, STATION_ID, STAGE_ID, SERVICE_PLAN_TYPE_ID,\n");        sql.append(" PRICE, SALE_TRANS_DATE, EFF_DATE, EXP_DATE, AUTO_RENEW,VEHICLE_ID,STATUS,VEHICLE_GROUP_ID,PLATE_NUMBER\n");        sql.append(" from SALE_TRANS_DETAIL STDD where 1= 1 \n");        if (!FnCommon.isNullOrEmpty(saleTransDetailVehicleOwnerAppDTO.getPlateNumber())) {            sql.append(" and UPPER(STDD.plate_number) like '%' || UPPER(?) ||'%'");            arrParams.add(saleTransDetailVehicleOwnerAppDTO.getPlateNumber());        }        if (!FnCommon.isNullOrEmpty(saleTransDetailVehicleOwnerAppDTO.getSaleTransDateFrom())) {            sql.append(" and TO_DATE(?, 'dd/mm/yyyy') <= SALE_TRANS_DATE\n");            arrParams.add(saleTransDetailVehicleOwnerAppDTO.getSaleTransDateFrom());        }        if (!FnCommon.isNullOrEmpty(saleTransDetailVehicleOwnerAppDTO.getSaleTransDateTo())) {            sql.append(" and TO_DATE(?, 'dd/mm/yyyy HH24:mi:ss') >= SALE_TRANS_DATE\n");            arrParams.add(saleTransDetailVehicleOwnerAppDTO.getSaleTransDateTo() + Constants.TIME_ONE_DAY);        }        sql.append(" ) std,\n");        sql.append(" SALE_TRANS st,\n");        sql.append(" SERVICE_PLAN_TYPE spt\n");        sql.append(" where \n");        sql.append(" std.SALE_TRANS_ID = st.SALE_TRANS_ID (+) \n");        sql.append(" AND\n");        sql.append(" std.SERVICE_PLAN_TYPE_ID = spt.SERVICE_PLAN_TYPE_ID (+)\n");        // sale trans type 2 is ticket histories        sql.append(" and st.SALE_TRANS_TYPE = '2'\n");        sql.append(" AND st.CONTRACT_ID = ? \n");        arrParams.add(contractId);        sql.append(" order by std.SALE_TRANS_DATE desc )\n");        sql.append(" where 1=1 \n");        if (saleTransDetailVehicleOwnerAppDTO.getEfficiencyId() != null && saleTransDetailVehicleOwnerAppDTO.getEfficiencyId() == 1) {            sql.append(" and efficiency = 1 \n");        }        if (saleTransDetailVehicleOwnerAppDTO.getEfficiencyId() != null && saleTransDetailVehicleOwnerAppDTO.getEfficiencyId() == 2) {            sql.append(" and efficiency = 0 \n");        }        /*        ==========================================================        Add param and query        ==========================================================        */        Integer start = 0;        if (saleTransDetailVehicleOwnerAppDTO.getStartrecord() != null) {            start = saleTransDetailVehicleOwnerAppDTO.getStartrecord();        }        Integer pageSize = null;        if (saleTransDetailVehicleOwnerAppDTO.getPagesize() != null) {            pageSize = saleTransDetailVehicleOwnerAppDTO.getPagesize();        }        return getListDataAndCount(sql, arrParams, start, pageSize, SaleTransDetailVehicleOwnerAppDTO.class);    }    /***     * Tim kiem ve dang hieu luc     * @param req     * @return     */    @Override    public ResultSelectEntity searchTicketPurchaseEfficiencyHistories(SaleTranTicketsDTO req) {        StringBuilder sql = new StringBuilder();        List<Object> arrParams = new ArrayList<>();        sql.append(" SELECT plateNumber, stationId, stageId, servicePlanTypeName, servicePlanTypeId,  \n");        sql.append(" chargeMethodId, price, saleTransDate, effDate, expDate,  \n");        sql.append(" epc, booCode, offerId, offerLevel, saleTransDetailId, subscriptionTicketId, status  \n");        sql.append(" FROM(\n");        sql.append(" select  \n");        sql.append(" std.plate_number                            as plateNumber,         -- bien so \n");        sql.append(" std.STATION_ID                              as stationId,           -- Ma tram  \n");        sql.append(" std.STAGE_ID                                as stageId,             --Ma doan  \n");        sql.append(" spt.NAME                                    as servicePlanTypeName, -- Loai ve  \n");        sql.append(" std.SERVICE_PLAN_TYPE_ID                    as servicePlanTypeId,   -- Ma loai ve \n");        sql.append(" sl.CHARGE_METHOD_ID                         as chargeMethodId,      -- Phuong thuc tinh phi  \n");        sql.append(" std.PRICE                                   as price,               -- So tien  \n");        sql.append(" to_char(std.SALE_TRANS_DATE, 'dd/MM/yyyy HH24:mi:ss')  as saleTransDate,       -- Ngay mua  (dd/MM/yyyy HH24:mi:ss) \n");        sql.append(" to_char(std.EFF_DATE, 'dd/mm/yyyy')         as effDate,             -- Tu ngay  (dd/mm/yyyy) \n");        sql.append(" to_char(std.EXP_DATE, 'dd/mm/yyyy')         as expDate,             -- Den ngay  (dd/mm/yyyy) \n");        sql.append(" std.epc                                     as epc,                                \n");        sql.append(" std.boo_code                                as booCode,                             \n");        sql.append(" std.ocs_code                                as offerId,                                \n");        sql.append(" std.offer_level                             as offerLevel,                          \n");        sql.append(" std.sale_trans_detail_id                    as saleTransDetailId,             \n");        sql.append(" std.subscription_ticket_id                  as subscriptionTicketId,            \n");        sql.append(" std.STATUS                                  as status              -- Trang thai  \n");        sql.append(" from SALE_TRANS_DETAIL std, SALE_TRANS st, SERVICE_PLAN_TYPE spt, SERVICE_PLAN sl  \n");        sql.append(" where std.SALE_TRANS_ID = st.SALE_TRANS_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_TYPE_ID = spt.SERVICE_PLAN_TYPE_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_ID = sl.SERVICE_PLAN_ID (+)  \n");        sql.append(" and std.status = 2  \n");        sql.append(" -- sale trans type 2 is ticket histories \n");        sql.append(" and st.SALE_TRANS_TYPE = 2 \n");        sql.append(" and st.contract_id <> 1 AND st.contract_id = ? \n");        arrParams.add(req.getContractId());        sql.append(" and to_date(sysdate, 'dd/mm/yyyy') BETWEEN TO_DATE(std.EFF_DATE, 'dd/mm/yyyy') AND TO_DATE(std.EXP_DATE, 'dd/mm/yyyy') \n");        sql.append(" and std.SUBSCRIPTION_TICKET_ID NOT IN (SELECT SUBSCRIPTION_TICKET_ID FROM sale_trans_del_boo1) \n");        sql.append(" UNION ALL \n");        sql.append(" (select  \n");        sql.append(" std.plate_number                            as plateNumber,         -- bien so \n");        sql.append(" std.STATION_ID                              as stationId,           -- Ma tram  \n");        sql.append(" std.STAGE_ID                                as stageId,             --Ma doan  \n");        sql.append(" spt.NAME                                    as servicePlanTypeName, -- Loai ve  \n");        sql.append(" std.SERVICE_PLAN_TYPE_ID                    as servicePlanTypeId,   -- Ma loai ve \n");        sql.append(" sl.CHARGE_METHOD_ID                         as chargeMethodId,      -- Phuong thuc tinh phi  \n");        sql.append(" std.PRICE                                   as price,               -- So tien  \n");        sql.append(" to_char(std.SALE_TRANS_DATE, 'dd/MM/yyyy HH24:mi:ss')  as saleTransDate,       -- Ngay mua  (dd/MM/yyyy HH24:mi:ss) \n");        sql.append(" to_char(std.EFF_DATE, 'dd/mm/yyyy')         as effDate,             -- Tu ngay  (dd/mm/yyyy) \n");        sql.append(" to_char(std.EXP_DATE, 'dd/mm/yyyy')         as expDate,             -- Den ngay  (dd/mm/yyyy) \n");        sql.append(" std.epc                                     as epc,                                \n");        sql.append(" std.boo_code                                as booCode,                             \n");        sql.append(" std.ocs_code                                as offerId,                                \n");        sql.append(" std.offer_level                             as offerLevel,                          \n");        sql.append(" std.sale_trans_detail_id                    as saleTransDetailId,             \n");        sql.append(" std.subscription_ticket_id                  as subscriptionTicketId,            \n");        sql.append(" std.STATUS                                  as status              -- Trang thai  \n");        sql.append(" from SALE_TRANS_DETAIL std, SALE_TRANS st, SERVICE_PLAN_TYPE spt, SERVICE_PLAN sl  \n");        sql.append(" where std.SALE_TRANS_ID = st.SALE_TRANS_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_TYPE_ID = spt.SERVICE_PLAN_TYPE_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_ID = sl.SERVICE_PLAN_ID (+)  \n");        sql.append(" and std.status = 2  \n");        sql.append(" -- sale trans type 2 is ticket histories \n");        sql.append(" and st.SALE_TRANS_TYPE = 2 \n");        sql.append(" and st.contract_id <> 1 AND st.contract_id = ? \n");        arrParams.add(req.getContractId());        sql.append(" AND to_date(sysdate, 'dd/mm/yyyy') < to_date(std.eff_date, 'dd/mm/yyyy') \n");        sql.append(" and std.SUBSCRIPTION_TICKET_ID NOT IN (SELECT SUBSCRIPTION_TICKET_ID FROM sale_trans_del_boo1) )\n");        sql.append(" )order by effdate asc \n");        Integer start = 0;        if (req != null && req.getStartRecord() != null) {            start = req.getStartRecord();        }        Integer pageSize = null;        if (req != null && req.getPageSize() != null) {            pageSize = req.getPageSize();        }        ResultSelectEntity listData = getListDataAndCount(sql, arrParams, start, pageSize, SaleTransDetailDTO.class);        return listData;    }    /**     * Tim kiem danh sach ve de huy khong hoan tien     *     * @param saleTranTicketsDTO     * @return     */    @Override    public ResultSelectEntity searchTicketHistories(SaleTranTicketsDTO saleTranTicketsDTO) {        StringBuilder sql = new StringBuilder();        List<Object> arrParams = new ArrayList<>();        sql.append(" select  \n");        sql.append(" std.plate_number                            as plateNumber,                    -- bien so              \n");        sql.append(" std.STATION_ID                              as stationId,                      -- Ma tram              \n");        sql.append(" std.STAGE_ID                                as stageId,                        --Ma doan               \n");        sql.append(" spt.NAME                                    as servicePlanTypeName,            -- Loai ve              \n");        sql.append(" sl.CHARGE_METHOD_ID                         as chargeMethodId,                 -- Phuong thuc tinh phi \n");        sql.append(" std.PRICE                                   as price,                          -- So tien              \n");        sql.append(" to_char(std.SALE_TRANS_DATE, 'dd/MM/yyyy')  as saleTransDate,                  -- Ngay mua             \n");        sql.append(" to_char(std.EFF_DATE, 'dd/mm/yyyy')         as effDate,                        -- Tu ngay              \n");        sql.append(" to_char(std.EXP_DATE, 'dd/mm/yyyy')         as expDate,                        -- Den ngay             \n");        sql.append(" std.epc                                     as epc,                                                    \n");        sql.append(" std.boo_code                                as booCode,                                                \n");        sql.append(" std.ocs_code                                as offerId,                                                \n");        sql.append(" std.offer_level                             as offerLevel,                                             \n");        sql.append(" std.sale_trans_detail_id                    as saleTransDetailId,                                      \n");        sql.append(" std.subscription_ticket_id                  as subscriptionTicketId,                                   \n");        sql.append(" std.AUTO_RENEW                              as autoRenew,                      -- Gia han tu dong thai \n");        sql.append(" std.STATUS                                  as status                         -- Trang thai            \n");        sql.append(" from SALE_TRANS_DETAIL std, SALE_TRANS st, SERVICE_PLAN_TYPE spt, SERVICE_PLAN sl                      \n");        sql.append(" where std.SALE_TRANS_ID = st.SALE_TRANS_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_TYPE_ID = spt.SERVICE_PLAN_TYPE_ID (+)  \n");        sql.append(" and std.SERVICE_PLAN_ID = sl.SERVICE_PLAN_ID (+)  \n");        sql.append(" -- sale trans type 2 is ticket histories \n");        sql.append(" and st.SALE_TRANS_TYPE = 2 \n");        sql.append(" and st.contract_id <> 1 AND st.contract_id = ? \n");        arrParams.add(saleTranTicketsDTO.getContractId());        sql.append(" and (to_date(sysdate, 'dd/mm/yyyy') BETWEEN TO_DATE(std.EFF_DATE, 'dd/mm/yyyy') AND TO_DATE(std.EXP_DATE, 'dd/mm/yyyy') \n");        sql.append(" or to_date(sysdate, 'dd/mm/yyyy') <= TO_DATE(std.EFF_DATE, 'dd/mm/yyyy')) \n");        sql.append(" and std.STATUS <> 4 \n");        sql.append(" and std.subscription_ticket_id  not in (select SUBSCRIPTION_TICKET_ID  from SALE_TRANS_DEL_BOO1 \n");        sql.append(" where 1=1 and status in (1,3)) \n");        sql.append(" order by std.EFF_DATE DESC \n");        Integer start = 0;        if (saleTranTicketsDTO != null && saleTranTicketsDTO.getStartRecord() != null) {            start = saleTranTicketsDTO.getStartRecord();        }        Integer pageSize = null;        if (saleTranTicketsDTO != null && saleTranTicketsDTO.getPageSize() != null) {            pageSize = saleTranTicketsDTO.getPageSize();        }        ResultSelectEntity listData = getListDataAndCount(sql, arrParams, start, pageSize, SaleTransDetailDTO.class);        return listData;    }}