package com.viettel.etc.controllers;import com.viettel.etc.dto.*;import com.viettel.etc.dto.ocs.OCSUpdateContractForm;import com.viettel.etc.services.ContractService;import com.viettel.etc.services.FileService;import com.viettel.etc.utils.Constants;import com.viettel.etc.utils.exceptions.DataNotFoundException;import com.viettel.etc.utils.exceptions.EtcException;import com.viettel.etc.xlibrary.core.constants.FunctionCommon;import com.viettel.etc.xlibrary.core.entities.CoreErrorApp;import com.viettel.etc.xlibrary.core.entities.UserSystemEntity;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.core.io.ByteArrayResource;import org.springframework.data.repository.query.Param;import org.springframework.http.HttpHeaders;import org.springframework.http.HttpStatus;import org.springframework.http.MediaType;import org.springframework.http.ResponseEntity;import org.springframework.security.core.Authentication;import org.springframework.security.core.annotation.AuthenticationPrincipal;import org.springframework.web.bind.annotation.*;import javax.validation.Valid;import javax.validation.constraints.NotNull;import java.io.IOException;import java.sql.Date;import static com.viettel.etc.utils.Constants.REQUEST_MAPPING_V1;/** * Autogen class: Lop thao tac hop dong * * @author ToolGen * @date Fri Jun 26 14:52:58 ICT 2020 */@RestController@RequestMapping(REQUEST_MAPPING_V1)public class ContractController {    @Autowired    private ContractService contractService;    @Autowired    private FileService fileService;    /**     * Tim kiem thong tin hop dong     *     * @param authentication:   Thong tin nguoi dung     * @param searchContractDTO     * @return     */    @RequestMapping(value = "/customers/contracts", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<Object> getDataContract(@AuthenticationPrincipal Authentication authentication,                                                  SearchContractDTO searchContractDTO) {        Object resultObj = contractService.searchContract(searchContractDTO);        return new ResponseEntity<>(FunctionCommon.responseToClient(resultObj), HttpStatus.OK);    }    /**     * Tim kiem hop dong theo id     *     * @param authentication     * @param contractId     * @return     */    @RequestMapping(value = "/customers/contracts/{id}", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<Object> findContractById(@AuthenticationPrincipal Authentication authentication,                                                   @PathVariable(name = "id") Long contractId) {        Object responseModel = contractService.findContractById(contractId);        return new ResponseEntity<>(FunctionCommon.responseToClient(responseModel), HttpStatus.OK);    }    /**     * Thong tin tai khoan chu phuong tien     * API App CPT     *     * @param authentication: Thong tin nguoi dung     * @return     */    @GetMapping(value = Constants.MOBILE + "/contracts", produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<Object> getDataUserContract(@AuthenticationPrincipal Authentication authentication) {        Object responseModel = contractService.getDataUserContract(authentication);        return new ResponseEntity<>(FunctionCommon.responseToClient(responseModel), HttpStatus.OK);    }    /**     * Tim kiem hop dong theo customer     *     * @param authentication: thong tin nguoi dung     * @param requestModel     * @return     */    @RequestMapping(value = "/customers/{id}/contracts", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<?> findContractByCustomer(@AuthenticationPrincipal Authentication authentication,                                                    @PathVariable(name = "id") Integer custId,                                                    SearchContractByCustomerDTO requestModel) {        Object listContract = contractService.findContractByCustomer(custId, requestModel);        return new ResponseEntity<>(FunctionCommon.responseToClient(listContract), HttpStatus.OK);    }    /**     * Tim kiem file dinh kem  theo contract_id cua chuc nang phe duyet     *     * @param authenEntity: thong tin nguoi dung     * @param authenEntity     * @return     */    @RequestMapping(value = "/customers/contracts/{id}/profiles/all", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<?> findProfileByContractAll(@AuthenticationPrincipal Authentication authenEntity,                                                      @PathVariable(name = "id") Long contractId,                                                      ContractProfileDTO requestModel) {        Object listContract = contractService.findProfileByContract(contractId, requestModel);        if (listContract == null) {            return new ResponseEntity<>(FunctionCommon.responseToClient(null), HttpStatus.NOT_FOUND);        }        return new ResponseEntity<>(FunctionCommon.responseToClient(listContract), HttpStatus.OK);    }    /**     * Tim kiem file dinh kem  theo contract_id     *     * @param authenEntity: thong tin nguoi dung     * @param authenEntity     * @return     */    @RequestMapping(value = "/customers/contracts/{id}/profiles", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<?> findProfileByContract(@AuthenticationPrincipal Authentication authenEntity,                                                   @PathVariable(name = "id") Long contractId,                                                   ContractProfileDTO requestModel) {        Object listContract = contractService.findProfileByContractId(contractId, requestModel);        if (listContract == null) {            return new ResponseEntity<>(FunctionCommon.responseToClient(null), HttpStatus.NOT_FOUND);        }        return new ResponseEntity<>(FunctionCommon.responseToClient(listContract), HttpStatus.OK);    }    /**     * Download file dinh kem     *     * @param authenEntity: thong tin nguoi dung     * @param authenEntity     * @param profileId     * @return     */    @RequestMapping(value = "/customers/contracts/profiles/{profileId}/download", method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<?> downloadProfileByContract(@AuthenticationPrincipal UserSystemEntity authenEntity,                                                       @PathVariable(name = "profileId") Integer profileId) {        ContractProfileDTO vehicleProfilePaginationDTO = contractService.downloadProfileByContract(profileId);        if (vehicleProfilePaginationDTO == null) {            return new ResponseEntity<>(FunctionCommon.responseToClient("FILE NOT FOUND"), HttpStatus.NOT_FOUND);        }        byte[] data = fileService.getFile(vehicleProfilePaginationDTO.getFilePath());        ByteArrayResource resource = new ByteArrayResource(data);        return ResponseEntity.ok()                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment;filename=" + vehicleProfilePaginationDTO.getFileName())                .contentType(MediaType.parseMediaType("application/octet-stream"))                .contentLength(data.length)                .body(resource);    }    /**     * Tim kiem hop dong theo : CONTRACT_NO, PlATE_NUMBER     *     * @param authentication: thong tin nguoi dung     * @param dataParams      params client     * @return     * @author Chucnd     */    @RequestMapping(value = "/contracts-info", method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)    public ResponseEntity<Object> findByPlateNumberAndContractNo(@AuthenticationPrincipal Authentication authentication,                                                                 ContractSearchDTO dataParams) {        if (dataParams != null && dataParams.getInputSearch() != null) {            Object resultObj = contractService.findByPlateNumberAndContractNo(dataParams);            return new ResponseEntity<>(FunctionCommon.responseToClient(resultObj), HttpStatus.OK);        } else {            return new ResponseEntity<>(FunctionCommon.responseToClient(""), HttpStatus.NO_CONTENT);        }    }    /**     * them chung tu di kem hop dong     *     * @param authentication           : thong tin nguoi dung     * @param customerId     * @param contractId     * @param updateContractProfileDTO     * @return     * @throws Exception     * @throws EtcException     */    @PutMapping(value = "/customers/{customerId}/contracts/{contractId}/profiles")    public ResponseEntity<Object> update(@AuthenticationPrincipal Authentication authentication,                                         @PathVariable Long customerId, @PathVariable Long contractId,                                         @RequestBody @Valid UpdateContractProfileDTO updateContractProfileDTO) throws Exception, EtcException {        contractService.updateProfile(authentication, new Date(System.currentTimeMillis()), customerId, contractId, updateContractProfileDTO.getActTypeId()                , updateContractProfileDTO.getReasonId(), updateContractProfileDTO.getContractProfiles());        return new ResponseEntity<>(FunctionCommon.responseToClient(CoreErrorApp.SUCCESS, null), HttpStatus.OK);    }    /**     * Xoa thong tin hop dong     *     * @param authentication thong tin nguoi dung     * @param customerId     * @param contractId     * @param profileId     * @return     * @throws IOException     * @throws EtcException     */    @PutMapping(value = "/customers/{customerId}/contracts/{contractId}/profiles/{profileId}")    public ResponseEntity<Object> deleteProfile(@AuthenticationPrincipal Authentication authentication,                                                @PathVariable Long customerId, @PathVariable Long contractId, @PathVariable Long profileId    ) throws IOException, EtcException {        contractService.deleteProfile(authentication, customerId, contractId, profileId);        return new ResponseEntity<>(FunctionCommon.responseToClient(CoreErrorApp.SUCCESS, null), HttpStatus.OK);    }    /**     * Lay thong tin hop dong ben OCS     *     * @param authentication     * @param contractId     * @return     * @throws DataNotFoundException     */    @GetMapping(value = "/customers/{customerId}/contracts/{contractId}/ocsInfo")    public ResponseEntity<Object> getOCSContractInfo(@AuthenticationPrincipal Authentication authentication,                                                     @PathVariable Long contractId) throws DataNotFoundException {        ContractDTO contractDTO = contractService.getOCSInfo(authentication, contractId);        return new ResponseEntity<>(FunctionCommon.responseToClient(contractDTO), HttpStatus.OK);    }    /**     * topUp     *     * @param authentication     * @return     */    @PutMapping(value = "contracts/topUp")    public ResponseEntity<Object> updateTopUpContract(@AuthenticationPrincipal Authentication authentication,                                                      @Valid @RequestBody OCSUpdateContractForm params,                                                      @NotNull @Param("actType") Long actType) {        Object result = contractService.updateTopUpContract(                authentication, params, actType);        return new ResponseEntity<>(FunctionCommon.responseToClient(result), HttpStatus.OK);    }    /**     * topUp     *     * @param authentication     * @return     */    @GetMapping(value = "contracts/topUp/minFee")    public ResponseEntity<Object> minFeeTopUpContract(@AuthenticationPrincipal Authentication authentication) {        Object result = contractService.minFeeTopUp(authentication);        return new ResponseEntity<>(FunctionCommon.responseToClient(result), HttpStatus.OK);    }}